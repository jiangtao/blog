# ä¿®å¤å›¾ç‰‡è¿ç§»å·¥å…·çš„æ•°æ®ä¸¢å¤±é—®é¢˜

## é—®é¢˜æè¿°

åœ¨ `migrate-manual.js` ä¸­å­˜åœ¨ä¸¥é‡çš„æ•°æ®ä¸¢å¤± bug:

å½“ `replaceImageLink` å‡½æ•°ç”±äº URL ç¼–ç å·®å¼‚ã€è§„èŒƒåŒ–é—®é¢˜æˆ–å…¶ä»–ä¸åŒ¹é…è€Œæ— æ³•åœ¨ Markdown ä¸­æ‰¾åˆ°åŒ¹é…çš„ URL æ—¶,å®ƒä¼šé™é»˜è¿”å›æœªä¿®æ”¹çš„å†…å®¹ã€‚ä½†æ˜¯ä»£ç ä»ç„¶ä¼š:

1. âœ… æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ "å·²è¿ç§»"
2. ğŸ—‘ï¸ æ— æ¡ä»¶åˆ é™¤ä¸´æ—¶å›¾ç‰‡æ–‡ä»¶  
3. âŒ Markdown ä¸­çš„è¯­é›€é“¾æ¥ä»ç„¶å­˜åœ¨(æœªè¢«æ›¿æ¢)

**ç»“æœ**: ç”¨æˆ·æ‰‹åŠ¨ä¸‹è½½çš„å›¾ç‰‡è¢«åˆ é™¤,è€Œæ–‡ç« ä¸­ä»ç„¶æ˜¯å¤±æ•ˆçš„è¯­é›€é“¾æ¥ã€‚

## æ ¹æœ¬åŸå› 

`replaceImageLink` å‡½æ•°åªè¿”å›å¤„ç†åçš„å†…å®¹å­—ç¬¦ä¸²,æ²¡æœ‰æä¾›æ›¿æ¢æ˜¯å¦æˆåŠŸçš„ä¿¡æ¯ã€‚è°ƒç”¨æ–¹æ— æ³•åˆ¤æ–­æ›¿æ¢æ˜¯å¦å®é™…å‘ç”Ÿã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `replaceImageLink` è¿”å›å€¼ç»“æ„

**ä¹‹å‰** (åªè¿”å›å­—ç¬¦ä¸²):
```javascript
function replaceImageLink(markdown, oldUrl, newPath, alt) {
  // ...
  return markdown.replace(regex, ...);
}
```

**ä¹‹å** (è¿”å›å¯¹è±¡åŒ…å«çŠ¶æ€ä¿¡æ¯):
```javascript
function replaceImageLink(markdown, oldUrl, newPath, alt) {
  let replacementCount = 0;
  
  const result = markdown.replace(regex, (match, capturedAlt) => {
    replacementCount++;
    // ...
  });

  return {
    content: result,      // å¤„ç†åçš„å†…å®¹
    replaced: replacementCount > 0,  // æ˜¯å¦å‘ç”Ÿæ›¿æ¢
    count: replacementCount           // æ›¿æ¢æ¬¡æ•°
  };
}
```

### 2. æ›´æ–° `migrate-manual.js` æ£€æŸ¥æ›¿æ¢çŠ¶æ€

åœ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶ä¹‹å‰éªŒè¯æ›¿æ¢æ˜¯å¦æˆåŠŸ:

```javascript
const replaceResult = replaceImageLink(currentContent, link.url, newPath, 'å›¾ç‰‡');

// æ£€æŸ¥æ›¿æ¢æ˜¯å¦æˆåŠŸ
if (!replaceResult.replaced) {
  failures++;
  console.error(`  âŒ æ›¿æ¢å¤±è´¥: URL åœ¨ Markdown ä¸­æœªæ‰¾åˆ°åŒ¹é…`);
  console.error(`     åŸå§‹ URL: ${link.url}`);
  console.error(`     æç¤º: å¯èƒ½æ˜¯ URL ç¼–ç å·®å¼‚å¯¼è‡´,ä¸´æ—¶æ–‡ä»¶ ${matchedImage} å·²ä¿ç•™`);
  continue; // è·³è¿‡åˆ é™¤ä¸´æ—¶æ–‡ä»¶
}

currentContent = replaceResult.content;
// ... å†™å…¥æ–‡ä»¶ ...

// åªåœ¨æˆåŠŸæ›¿æ¢ååˆ é™¤ä¸´æ—¶æ–‡ä»¶
fs.unlinkSync(tempImagePath);
```

### 3. åŒæ­¥æ›´æ–° `image-lint-cli.js`

ç¡®ä¿è‡ªåŠ¨è¿ç§»åŠŸèƒ½ä¹Ÿä½¿ç”¨æ–°çš„è¿”å›æ ¼å¼å¹¶æ£€æŸ¥æ›¿æ¢çŠ¶æ€ã€‚

## æµ‹è¯•éªŒè¯

åˆ›å»ºæµ‹è¯•ç”¨ä¾‹éªŒè¯:

1. âœ… æ­£å¸¸ URL åŒ¹é…æˆåŠŸ
2. âœ… URL ä¸åŒ¹é…æ—¶è¿”å› `replaced: false`
3. âœ… å¸¦æŸ¥è¯¢å‚æ•°çš„ URL æ­£ç¡®åŒ¹é…
4. âœ… å†…å®¹æœªä¿®æ”¹æ—¶ä¿æŒåŸæ ·

## å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶:
- `home/bin/image-replacer.js` - æ ¸å¿ƒå‡½æ•°ä¿®æ”¹
- `home/bin/migrate-manual.js` - æ·»åŠ æ›¿æ¢çŠ¶æ€æ£€æŸ¥
- `home/bin/image-lint-cli.js` - åŒæ­¥æ›´æ–°
- `home/bin/image-replacer.test.js` - æ›´æ–°æµ‹è¯•ç”¨ä¾‹

### å‘åå…¼å®¹æ€§:
âš ï¸ **Breaking Change**: `replaceImageLink` çš„è¿”å›å€¼ä»å­—ç¬¦ä¸²æ”¹ä¸ºå¯¹è±¡ã€‚
æ‰€æœ‰è°ƒç”¨æ–¹éƒ½å·²åŒæ­¥æ›´æ–°,ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½ã€‚

## å®‰å…¨æ€§æ”¹è¿›

1. **æ•°æ®ä¿æŠ¤**: åªåœ¨ç¡®è®¤æ›¿æ¢æˆåŠŸåæ‰åˆ é™¤åŸå§‹æ–‡ä»¶
2. **æ˜ç¡®åé¦ˆ**: å¤±è´¥æ—¶æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œå»ºè®®
3. **å¤±è´¥è®¡æ•°**: æ­£ç¡®å¢åŠ  failures è®¡æ•°,å½±å“æœ€ç»ˆé€€å‡ºç 

## éƒ¨ç½²è¯´æ˜

æ­¤ä¿®å¤å·²åŒ…å«åœ¨å½“å‰åˆ†æ”¯ä¸­,æ— éœ€é¢å¤–é…ç½®ã€‚è¿è¡Œ `npm run migrate:images` å³å¯ä½¿ç”¨ä¿®å¤åçš„ç‰ˆæœ¬ã€‚

## ç›¸å…³ Issue

ä¿®å¤ç”±ä»£ç å®¡æŸ¥ä¸­å‘ç°çš„æ•°æ®ä¸¢å¤±é£é™©å¼•èµ·ã€‚
